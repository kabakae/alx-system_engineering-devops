#!/usr/bin/env bash
# Check if the script is run as root
if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root"
    exit 1
fi

# Set Nginx to run as the nginx user
if ! sed -i 's/^user .*;$/user nginx;/' /etc/nginx/nginx.conf; then
    echo "Failed to update nginx.conf to run as nginx user"
    exit 1
fi

# Configure Nginx to listen on all active IPs on port 8080
if ! sed -i 's/^ *listen .*;$/    listen 8080 default_server;/' /etc/nginx/sites-available/default; then
    echo "Failed to update the listen port in default site configuration"
    exit 1
fi

# Restart Nginx and check if the restart was successful
if ! service nginx restart; then
    echo "Failed to restart Nginx"
    exit 1
fi

# Check if Nginx is installed
if ! dpkg-query -W -f='${Status}' nginx 2>/dev/null | grep -q "ok installed"; then
    echo "Nginx is not installed, skipping removal"
    exit 0
fi

# Remove Nginx using apt-get remove
if ! apt-get remove -y nginx; then
    echo "Failed to remove Nginx"
    exit 1
fi

echo "Nginx configuration updated, service restarted, and Nginx removed successfully (if it was installed)"
exit 0
